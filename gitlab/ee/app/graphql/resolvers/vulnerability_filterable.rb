# frozen_string_literal: true

module Resolvers
  module VulnerabilityFilterable
    extend ActiveSupport::Concern

    MAX_VULNERABILITY_COUNT_GROUP_SUPPORT = 20_000

    private

    def validate_filters(filters)
      validate_owasp_top_ten(filters) if filters[:owasp_top_10].present?
      validate_filter_by_identifier_name if filters[:identifier_name].present?
    end

    def validate_filter_by_identifier_name
      return unless object.is_a?(Group)

      vulnerability_count = ::Security::ProjectStatistics.sum_vulnerability_count_for_group(object)
      allowed = vulnerability_count <= MAX_VULNERABILITY_COUNT_GROUP_SUPPORT

      raise ::Gitlab::Graphql::Errors::ArgumentError, 'Group has more than 20k vulnerabilities.' unless allowed
    end

    def validate_owasp_top_ten(filters)
      owasp_top_ten = filters[:owasp_top_10]

      includes_filter_none = owasp_top_ten.include?(::Security::VulnerabilityReadsFinder::FILTER_NONE)

      return if owasp_top_ten.size <= 1

      return unless includes_filter_none

      raise ::Gitlab::Graphql::Errors::ArgumentError,
        'Incompatible argument: owasp_top_ten. "NONE" wildcard cannot be combined with other OWASP top 10 values.'
    end
  end
end
